version: 2

# References to reduce duplication in the rest of the config
references:
  container: &container_config
    docker:
      - image: circleci/node:8-browsers
  cache_key: &cache_key
    dependency-cache-{{ checksum "bower.json" }}
  cache_node_modules: &cache_node_modules
    save_cache:
      key: *cache_key
      paths:
        - node_modules
  restore_node_modules: &restore_node_modules
    restore_cache:
      keys:
        - *cache_key

# Circle jobs
jobs:

  # Ensure that the image set manifest is in place
  test:
    <<: *container_config
    steps:
      - checkout
      - *restore_node_modules
      - run:
          name: Install dependencies
          command: npx origami-build-tools@^7 install
      - *cache_node_modules
      - run:
          name: Build accessibility testing demo
          command: npx origami-build-tools@^7 demo --demo-filter pa11y --suppress-errors
      - run:
          name: Run linters
          command: npx origami-build-tools@^7 verify
      - run:
          name: Run tests
          command: npx origami-build-tools@^7 test

  # Commit the generated files
  commit:
    <<: *container_config
    steps:
      - checkout
      - *restore_node_modules
      - run:
          name: Install dependencies
          command: npx origami-build-tools@^7 install
      - run:
          name: Build the icon lists
          command: node scripts/build-icon-list.js
      - run:
          name: Commit and push the icon list changes
          command: >
            if [ ! "$(git status --porcelain)" == "" ]; then
              git config --global user.email "origami.support@ft.com";
              git config --global user.name "origamiserviceuser [bot]";
              git add scss/_icon-list.scss demos/src/data.json
              git commit -m 'Updating Sass list of icons and demos [ci skip]';
              git push origin master;
            fi

# Circle workflows
workflows:
  version: 2
  test-and-commit:
    jobs:
      - test
      - commit:
          requires:
            - test
          filters:
            branches:
              only: master
